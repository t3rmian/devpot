---
title: Android – CI
url: android-ci
id: 23
category:
- mobile: Mobile
tags:
  - android
  - ci
author: Damian Terlecki
date: 2020-02-09T20:00:00
---

Skonfigurowanie ciągłej integracji aplikacji Androidowej, uwzględniającej testy interfejsu użytkownika, może okazać się wyzwaniem. Do tego zadania nie wystarczy instalacja standardowego JDK. Musimy również pobrać, stworzyć i uruchomić emulator Androida. Może to zająć **całkiem sporo czasu**. Nawet po udanym buildzie może się okazać, że testy zajmują całe wieki, a lokalnie wszystko działa płynnie. Dokładna konfiguracja może się różnić w zależności od usługi bądź serwera CI. Podstawowe kroki, jakie należy wykonać w celu konfiguracji CI projektu Androidowego są jednak dosyć zrozumiałe:

1. Instalacja Java JDK
2. Instalacja Android SDK (akceptacja licencji)
3. Pobranie kodu
4. Zbudowanie aplikacji
5. Uruchomienie testów jednostkowych
6. Pobranie emulatora Androida
7. Utworzenie instancji emulatora
8. Poczekanie na uruchomienie emulatora (odblokowanie ekran)
9. Odpalenie testów instrumentacyjnych
10. Zebranie wyników wyniki (pokrycie kodu, błędy, zrzuty ekranu)

W zależności od narzędzia niektóre z tych kroków jak instalacja mogą wymagać jedynie jednorazowego ich wykonania. Gdzieś pomiędzy tymi krokami, warto również zatrzymać się na moment i zastanowić się nad [akceleracją sprzętową](https://developer.android.com/studio/run/emulator-acceleration).

### Travis i CircleCI

[Travis](https://docs.travis-ci.com/user/languages/android/) i [CircleCI](https://circleci.com/docs/2.0/language-android/) mają całkiem fajne opcje wspierające CI dla projektów Androidowych. W przypadku testów jednostkowych sprawdzają się one świetnie. Jeśli chodzi o testy instrumentacyjne, z tym jest już nieco gorzej. Właściwa konfiguracja może nie być trywialna. Obecnie możemy przeczytać, że:

> **[Travis]** Ostrzeżenie: obecnie te kroki nie są w pełni obsługiwane przez konstruktora Travis CI Android.<br/>
> **[CircleCI]** Uwaga: Uruchamianie emulatora Androida nie jest obsługiwane przez typ wirtualizacji używanej przez CircleCI w systemie Linux.

Mimo tego metodą prób i błędów w obu serwisach jesteśmy w stanie uruchomić testy instrumentacyjne na emulatorze, bez konieczności polegania usługach firm trzecich, takich jak Firebase Test Lab. W przypadku CircleCI istnieje [konfiguracja stworzona przez Dogu Deniz Ugur](https://github.com/c2mInc/Circle-CI-Instrumentation-Tests-for-Android), która wykorzystuje środowisko MacOS do uruchamiania emulatora. W przypadku Travisa nie miałem szczęścia do domyślnej konfiguracji zamieszczonej w dokumentacji ani żadnej innej z przypadkowych artykułów.


<img src="/img/hq/android-wait-for-emulator.png" title="1. Emulator Androida nie uruchamia się" alt="Android Emulator does not start. No output has been received in the last 10m0s. The build has been terminated." />

<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAqoAAAASCAMAAACkXQxpAAAARVBMVEVERETx8fGtra2Dg4OcnJxxcXHU1NTe3t7Dw8Pj4+Pn5+fZ2dns7OxlZWVUVFRaWlpNTU1dXV3Ozs7Jycm5ubmRkZGkpKQoTGm+AAAFSUlEQVRo3u1ZDXPaMAw1diIrDpAWuv3/nzrrqwI7GWN0u+0u71ZcsJCepBfVycKOHTt27NixY8dvIpVDHoPjMoQ/A4RgGCGFHsOl/WBys8cbjpjH7T1ULj8HYBPtBazywcMh0rqd4N/CcDwcMPw9nM4hLKeKJbzRctbl6UqO8/AL4q6IAerrcQgo7+htHjnxAzyQasppjQe8LNXHwN+VaqRkLfdUIIw5j4BavuEYw3MY85NSxZKoRF8OwJ/qOKqaY2VcUy+JVwjW8GdzX5az/vIW3pZQQUsfl6s9T+WjxkJgdZhU0WgQD6OTcjwKrTx2QoPI30Xk0mK1AAjDPFIXmgSqu+MMnB2o1tH4WM5RlE9rScxntobJV/Cmk5daO+Oc8kfdZJt8RVpYPPPVbD78ykCpNs6Zg8AHrRJS1ch+SsZwn+9QhhBL0tzTNA3DNJtU4yHPnm2cjwCHqJwbPo1U79queW1cyzhhiGAsDYhQ37IfbPyoxKw+HosX10RFFFNiybYKzoupUodtiiHQJywbwLCau8XqcX47n+WXJWxLdcxIEdM0AFRF3Uu1fhoAZKoaHazvJn77WKpDFsWuSZXNxgzU6wDIHpwPxeJPI4gouQrEB4tLDEgsXl80G4D6DVA/vEH1Hu9tzI9P1dpdQG6/hyTadMEhubyVKoyBN6qBSTVfEK+fUpVieLLfSkRUzg2fRqpSZ2k706caScgWOM9jBG5U9IRiufAm0+dIiOaHPymD1ScC0bQmCIy5mlbvnOD9rvZUpcELQt3Zzt1iNWBVqlTfSa6nCl3avypabcQEjVQJ0aRKZlbGjQMA5SsL8jQUeU6Jr9LuS4DszjpbKTif+s/D6/401IUNDMLMM7FNaV7dFAagUmUbiqN+ugOA/uTRQwb5qvtxiHXd0dxTHuY5bkkVKpuIyrnhcytVffHCVBsj0gMRYgQj61JN5swvZ/WjBdb6qKnFupeqmvJVewsV5PdjBOTcsTr+nqFKMkfI36e0mrvG6rEElep5sTH77ksz6zekysJTqcqrDRpHN1W5ZIhkZVKVcd0CtCNEQKTqfCSiS/XA0o/A7m65H1upsr/XpHobMiCzq642pepTNQEOD6SqnLel6nUGKR4LZt6Uav3rDFwlb4tGHzOlAFynKhL1w3EBTaohUnrShFaqatpdKD47AWVMSdNJqsJ5NXeL1eLtRFj4pGofvdvSn9VvpYoqVXnpp+oDqfK3EPkgk5EvcRlL21PVPDiffqrqogZm009V5fy6VPNoXrenKl1hxaTKywOpVj9fPFUDgE/VRqrR7WB9qlojPLV+qq5K1TbVgXPezt1i9eCpaspcFhqvtjiMiklVz48u1VSas2rkn+2zquwjMivkIxC3pb8nRvYuygb24Hzas+o08IApfsYUU+ymqnA2qcphr5Gq+dmWqofkC84Pjf2tcCypkSqK+aZU8cFUbW5R7KwqaGtIexciS+b3UtUa8hLB/Ojt0Gd9kJxoExqpqumqVG1TzrJDw3k1d4n1UKrh/XR616U/ZMbPqUp35Vf9o1xS3SvxCLdPAiA0UnU3FUgMqSDEiAVBI1+P4Ng/ASgXcU6OxFb42Dvy688F2PTq0xDrFnDfXarG2VpR3+YZLSGVRuNH7nQbqWpIKkgseVQ/t2geVqFKlWooTxAI2LRLOTd8nEbd7p4AZGK3KdUxgxFppKq39cJH/ViyXh8Kok1opKqmjVQtr1Ts2Yz1C6UnENZzt1g7nnhY6e183TeGP4wq53/Kz44vh08qCC3Ah9Dr/6/XinWX6o4dO3bs2LFjx44d/zV+AFf+PO9lBnvUAAAAAElFTkSuQmCC" title="2. Emulator Androida i wiszący wątek" alt="emulator: ERROR: detected a hanging thread 'QEMU1 main loop'. No response for 105001 ms." />

<img src="data:image/png;base64,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" title="3. Nie znaleziono ABI lub nie zostało poprawnie zainstalowane" alt="Valid ABIs: no ABIs. Error: Invalid --abi armeabi-v7a for the selected target." />


Jeśli napotkasz na przeszkodę, którą ciężko Ci pokonać, dobrym pomysłem będzie przyjrzenie się projektom typu open-source, które korzystają z wybranej przez Ciebie usługi. Jednym z przykładów jest dość popularna aplikacja [AnkiDroid](https://github.com/ankidroid/Anki-Android) ze skonfigurowaną ciągłą integracją na [Travisie](https://travis-ci.org/ankidroid/Anki-Android/builds/640933301?utm_source=github_status&utm_medium=notification). Parę razy, gdy moje buildy niespodziewanie zaczęły kończyć się niepowodzeniem, źródło problemu znajdowałem, śledząc zmiany [Mike'a Hardy'iego](https://github.com/mikehardy) – jednego z autorów AnkiDroid. W większości przypadków problemy dotyczyły aktualizacji [kanału](https://developer.android.com/studio/command-line/sdkmanager#options) lub [aktualizacji wersji](https://developer.android.com/studio/releases/emulator) emulatora.

### Kolejne kroki

Konfiguracja ciągłej integracji dla projektu Androidowego to nie koniec przygody. Warto rozważyć następujące usprawnienia:

1. [Stworzenie pakiety testowych i zrównoleglenie testów](/en/posts/test-suites-categorization-and-parallelism), jeśli mamy dużo testów UI i zajmują one zbyt dużo czasu.
2. [Implementacja powtarzania nieudanych testów](/en/posts/flaky-tests-repetition) w celu rozwiązania problemu testów niedeterministycznych i ustabilizowania buildów.
3. [Przechwytywanie i przesyłanie zrzutów ekranu przy niepowodzeniu testu](/en/posts/android-screen-capture-test-watcher), aby uzyskać dodatkowe informacje z serwera o tym, jak wyglądał interfejs użytkownika i co mogło być powodem błędu.

Ostatnim krokiem może być ustawienie ciągłego wdrażania (CD), np. automatycznego wrzucania aplikacji do testów wewnętrznych na Google Play. W tym przypadku narzędzie Fastlane może znacząco ułatwić ten proces.